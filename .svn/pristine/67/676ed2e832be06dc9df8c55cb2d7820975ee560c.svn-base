<template>
	<transition name="modal-fade">
		<div class="modal-backdrop">
			<div class="modal" @click.stop>
				<div class="modal-header">
					<slot name="header">
						<h2>活动券设置---添加</h2>
					</slot>
				</div>
				<div class="modal-body" id="modal-body">
					<slot name="body">
						<el-col :span="7" class="gutterspan">
							<div class="box">
								<div class="form-group" v-bind:class="{'form-group--error': $v.mealName.$error }">
									<span class="mc">套餐名称</span>
									<el-input @blur="verification" v-model="mealName" class="name1" clearable>
									</el-input>
								</div>
								<span class="form-group__message" v-if="!$v.mealName.required">不能为空</span>
							</div>
						</el-col>
						<el-col :span="7" class="gutterspan">
							<div class="box">
								<div class="form-group" v-bind:class="{'form-group--error': $v.beginTime.$error }">
									<span class="mc">发放日期</span>
									<el-date-picker v-model="beginTime" class="xl" @blur="verification" type="date">
									</el-date-picker>
								</div>
								<span class="form-group__message" v-if="!$v.beginTime.required">不能为空</span>
							</div>
						</el-col>
						<el-col :span="7" class="gutterspan">
							<div class="box">
								<div class="form-group" v-bind:class="{'form-group--error': $v.endTime.$error }">
									<span class="mc">结束日期</span>
									<el-date-picker v-model="endTime" class="xl" @blur="verification" type="date">
									</el-date-picker>
								</div>
								<span class="form-group__message" v-if="!$v.endTime.required">不能为空</span>
							</div>
						</el-col>
						<el-col :span="7" class="gutterspan">
							<div class="box">
								<div class="form-group" v-bind:class="{'form-group--error': $v.useEndTimeSum.$error }">
									<span class="mc">使用有效期</span>
									<el-input @blur="verification" v-model="useEndTimeSum" class="name1" clearable>
									</el-input>
								</div>
								<span class="form-group__message" v-if="!$v.useEndTimeSum.required">不能为空</span>
							</div>
						</el-col>
						<el-col :span="7" class="gutterspan">
							<div class="box">
								<div class="form-group" v-bind:class="{'form-group--error': $v.sort.$error }">
									<span class="mc">排序</span>
									<el-input @blur="verification" v-model="sort" class="name1" clearable>
									</el-input>
								</div>
								<span class="form-group__message" v-if="!$v.sort.required">不能为空</span>
							</div>
						</el-col>
						<el-col :span="7" class="gutterspan">
							<div class="box">
								<div class="form-group" v-bind:class="{'form-group--error': $v.salesPushMoney.$error }">
									<span class="mc">销售提成</span>
									<el-input @blur="verification" v-model="salesPushMoney" class="name1" clearable>
									</el-input>
								</div>
								<span class="form-group__message" v-if="!$v.salesPushMoney.required">不能为空</span>
							</div>
						</el-col>
						<el-col :span="7" class="gutterspan">
							<div class="box">
								<div class="form-group" v-bind:class="{'form-group--error': $v.state.$error }">
									<span class="mc">套餐状态</span>
									<el-select @blur="verification" class="xl" v-model="state">
										<el-option v-for="item in activestate" :key="item.value" :label="item.label" :value="item.value"></el-option>
									</el-select>
								</div>
								<span class="form-group__message" v-if="!$v.state.required">不能为空</span>
							</div>
						</el-col>
						<el-col :xs="24" :sm="24" :md="24" :lg="24" :xl="24">
							<el-tree default-expand-all :data="bussarrs" node-key="id" show-checkbox accordion highlight-current ref="tree" :props="defaultProps">
							</el-tree>
						</el-col>
						<el-col class="row reformbox" :xs="24" :sm="24" :md="24" :lg="24" :xl="24">
							<div class="reforms">
								<h5>商品/服务列表<i class="el-collapse-item__arrow el-icon-arrow-right"></i></h5>
							</div>
							<div class="icons">
								<el-tooltip class="item" effect="dark" content="商品添加" placement="top">
									<i class="el-icon-circle-plus-outline xinzeng" size="small" @click="shoplistAdd"></i>
								</el-tooltip>
							</div>
							<div class="iconss">
								<el-tooltip class="item" effect="dark" content="服务添加" placement="top">
									<i class="el-icon-circle-plus-outline xinzeng" size="small" @click="fuwulistAdd"></i>
								</el-tooltip>
							</div>
						</el-col>
						<el-col :xs="24" :sm="24" :md="24" :lg="24" :xl="24">
							<!--<div id="tablist">-->
							<el-table ref="multipleTable" :data="servList" height="300" tooltip-effect="dark" style="width: 100%">
								<el-table-column prop="goodsNames" label="商品/服务名称" show-overflow-tooltip>
								</el-table-column>
								<el-table-column prop="goodsPrices" label="商品/服务原价" show-overflow-tooltip>
								</el-table-column>
								<el-table-column prop="mealPrices" label="套餐内售价" show-overflow-tooltip>
									<input type="text" />
								</el-table-column>
								<el-table-column prop="mealCounts" label="数量" show-overflow-tooltip>
									<input type="text" />
								</el-table-column>
								<el-table-column prop="units" label="单位" show-overflow-tooltip>
								</el-table-column>
								<el-table-column prop="orderSums" label="原价小计" show-overflow-tooltip>
								</el-table-column>
								<el-table-column prop="useEndTimeSum" label="套餐价小计" show-overflow-tooltip>
								</el-table-column>
								<el-table-column label="操作" width="180">
									<template slot-scope="scope">
										<el-button type="text" size="small" @click="deletes(scope.$index,servList)">删除</el-button>
									</template>
								</el-table-column>
							</el-table>
							<!--</div>-->
						</el-col>
					</slot>
				</div>
				<div class="modal-footer">
					<slot name="footer">
						<el-button class="el-button el-button--primary queding" @click="determine">确定</el-button>
						<button type="button" class="el-button el-button--default guanbi" @click="close">关闭</button>
					</slot>
				</div>
				<mealList v-show="listadd" @close="closeModal" v-on:close="serlfs" v-on:closes="serlf" v-bind:shopList="shopList"></mealList>
			</div>
		</div>
	</transition>
</template>

<script>
	import { required, numeric, minLength, maxLength, or } from 'vuelidate/lib/validators'
	import mealList from './mealList.vue'
	export default {
		props: ['uuid'],
		components: {
			mealList
		},
		data() {
			return {
				menuId: this.$route.query.menuIds,
				store: this.$storage.fetch("bussiness"),
				isAdmin: this.$storage.fetch("isAdmin"),
				bussinessId: this.$storage.fetch("buss"),
				activestate: [{
						value: '0',
						label: '停用'
					},
					{
						value: '1',
						label: '启用'
					},
				],
				defaultProps: {
					children: 'children',
					label: 'name'
				},
				//新增基础元素
				mealName: '',
				beginTime: '',
				endTime: '',
				useEndTimeSum: '',
				sort: '',
				salesPushMoney: '',
				state: '',
				//功能元素
				bussinessID: '',
				bussinessName: '',
				bussarrs: '',
				//表格元素
				servList: '',
				listadd: false,
				isService:'',
				shopList:'',
			}
		},
		mounted: function() {
			this.bussinessID = this.bussinessId;
			console.log(this.bussinessID);
			for(let i in this.store) {
				if(this.bussinessID == this.store[i].bussinessID) {
					this.bussinessName = this.store[i].bussinessName
				}
				console.log(this.bussinessName)
			}
			this.$ajax.post(`${this.$url}/activityTicket/selectStoreTree.html`, {
					bussinessID: this.bussinessID,
					bussinessName: this.bussinessName,
				}).then(data => {
					console.log(data)
					this.bussarrs = data.data.bussTree
				})
				.catch((error) => {
					console.log(error)
					this.$message.error('获取数据失败');
				})
		},
		validations: {
			mealName: {
				required
			},
			beginTime: {
				required
			},
			endTime: {
				required
			},
			useEndTimeSum: {
				required
			},
			sort: {
				required
			},
			salesPushMoney: {
				required
			},
			state: {
				required
			},
		},
		methods: {
			//验证
			verification() {
				this.$v.mealName.$touch()
				if(this.$v.mealName.$error) {
					return false;
				}
				this.$v.beginTime.$touch()
				if(this.$v.beginTime.$error) {
					return false;
				}
				this.$v.endTime.$touch()
				if(this.$v.endTime.$error) {
					return false;
				}
				this.$v.useEndTimeSum.$touch()
				if(this.$v.useEndTimeSum.$error) {
					return false;
				}
				this.$v.sort.$touch()
				if(this.$v.sort.$error) {
					return false;
				}
				this.$v.salesPushMoney.$touch()
				if(this.$v.salesPushMoney.$error) {
					return false;
				}
				this.$v.state.$touch()
				if(this.$v.state.$error) {
					return false;
				}
				return true;
			},
			shoplistAdd() {
				this.isService='2'
				this.$ajax.post(`${this.$url}/meal/selectServiceList.html`, {
					  bussinessID:this.bussinessID,
					  isService:this.isService
					}).then(data => {
						console.log(data)
						this.shopList=data.data.servicelist
						this.listadd = true
					})
					.catch((error) => {
						console.log(error)
						this.$message.error('获取数据失败');
					})
				this.listadd = true
			},
			fuwulistAdd() {
				this.isService='1'
				this.$ajax.post(`${this.$url}/meal/selectServiceList.html`, {
					
					}).then(data => {
						console.log(data)
						this.shopList=data.data.servicelist
					    this.listadd = true
					})
					.catch((error) => {
						console.log(error)
						this.$message.error('获取数据失败');
					})
				
			},
			determine() {

				//				if(!this.verification()) {
				//					return false;
				//				}
				let listName = [].concat(this.$refs.tree.getCheckedNodes())
				let listTree = [].concat(this.$refs.tree.getCheckedKeys())
				let ls = [].concat(this.$refs.tree.getHalfCheckedKeys());
				if(ls == '') {
					listTree[0] = '';
				}
				if(listTree.length > 0) {
					for(let i = 0; i < listTree.length; i++) {
						if(storeId == '') {
							storeId = listTree[i];
							//							storeName=listTree[i].name;
						} else {
							storeId = storeId + ',' + listTree[i];
							//							storeName=storeName+','+listTree[i].name;
						}
					}
				}
				//获取选中的门店名称
				let storeName = [];
				let storeids = storeId.split();
				console.log(storeids);
				for(let i in storeids) {
					//alert(storeids[i]);
					for(let j in listName) {
						if(storeids[i] == listName[j].id) {}
						storeName.push(listName[j].name)
					}
				}
				console.log(storeId)
				console.log(storeName)
				let storeNames = storeName.join(',')
				//              console.log(this.times)
				this.beginTime = this.formatDate(this.beginTime);
				this.endTime = this.formatDate(this.endTime);

				//				this.$ajax.post(`${this.$url}/meal/insertMeal.html`, {
				//						uuid: this.uuid,
				//						
				//					}).then(data => {
				//						console.log(data)
				//						this.$emit('closes');
				//						this.$message({
				//							type: 'success',
				//							message: data.data.message
				//						});
				//						//						this.activity=data.data.data.list
				//						//						this.uuid=data.data.uuid
				//					})
				//					.catch((error) => {
				//						console.log(error)
				//						this.$message.error('获取数据失败');
				//					})

			},
			close() {
				this.$emit('close');
				this.$router.push({
					name: 'backs',
					query: {
						menuIds: this.menuId,
					}
				})
			},
			closeModal() {
				this.listadd = false
			},
			formatDate: function(time) {
				var y = time.getFullYear();
				var m = time.getMonth() + 1;
				m = m < 10 ? '0' + m : m;
				var d = time.getDate();
				d = d < 10 ? ('0' + d) : d;
				return y + '-' + m + '-' + d;
			},

			//			GMTToStr(time) {
			//				let date = new Date(time)
			//				let Str = date.getFullYear() + '-' +
			//					(date.getMonth() + 1) + '-' +
			//					date.getDate()
			//				return Str
			//			},
		},
	}
</script>
<style>
	.reforms h5 {
		width: 130px;
		background: #00bafc;
		padding: 10px;
		text-align: center;
		font-size: 14px;
		float: left;
		color: #fff;
	}
	
	.reformbox {
		position: relative;
	}
	
	.icons {
		position: absolute;
		top: 2px;
		right: 50px;
		height: 42px;
		line-height: 40px;
		display: inline-block;
	}
	.iconss {
		position: absolute;
		top: 2px;
		right: 21px;
		height: 42px;
		line-height: 40px;
		display: inline-block;
	}
</style>